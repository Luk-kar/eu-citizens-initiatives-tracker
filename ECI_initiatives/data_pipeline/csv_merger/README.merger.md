# ECI Data Merger

This module is the **final consolidation step** in the ECI pipeline. It takes the two parallel datasets generated by the extraction process‚Äîthe official Commission response data and the granular follow-up website data‚Äîand intelligently merges them into a single, comprehensive accountability record.

## üöÄ Purpose

The merger reconciles the "official promise" with the "evolving reality":

- **Base Data** (`eci_responses_*.csv`): Captures the official Commission Answer text, original deadlines, and formal commitments at the moment of response.
- **Follow-up Data** (`eci_responses_followup_website_*.csv`): Captures updated timelines, implementation dates, and specific actions (workshops, studies) from dedicated project sites.

**Key Goals:**
- **Accountability**: Distinguish between what was *originally promised* vs. what is *currently planned* (e.g., merging deadlines with clear labeling).
- **Completeness**: Fill gaps where one source has data the other misses (e.g., specific legislation IDs found only in follow-up text).
- **Integrity**: Enforce strict validation rules (e.g., `registration_number` must match) and prevent illogical status updates (e.g., warning if dates move backward).

## üìÇ Project Structure

- **`responses/merger.py`**: The core engine that orchestrates the file loading, validation, and row-by-row merging.
- **`responses/strategies.py`**: Defines field-specific merge logic (e.g., `merge_dates_by_latest`, `merge_json_lists`, `merge_by_concatenation`).
- **`responses/exceptions.py`**: Custom errors for data integrity failures (e.g., `ImmutableFieldConflictError`).
- **`responses/cli.py`**: Command-line interface logic.

## ‚öôÔ∏è Merge Strategy

The merger uses a column-by-column strategy to handle data conflicts. It doesn't just "overwrite"‚Äîit makes semantic decisions based on the field type:

| Field Type | Strategy | Example |
| :--- | :--- | :--- |
| **Immutable IDs** | `Keep Base` | `registration_number` (never changes) |
| **Outcomes** | `Prioritize Followup` | `final_outcome_status` (e.g. updates from "Studying" -> "Adopted") |
| **Text/Reasons** | `Concatenate` | `commission_rejection_reason` (keeps original + adds new updates) |
| **Dates** | `Max / Latest` | `followup_latest_date` (always takes the most future date) |
| **Lists (JSON)** | `Merge & Deduplicate` | `laws_actions`, `court_cases_referenced` (combines unique items) |
| **Booleans** | `Logical OR` | `commission_promised_new_law` (once promised, always true) |

*Full strategy details are documented in `strategies.py`.*

## üß™ Testing

For comprehensive testing documentation and instructions, see the [main project testing documentation](../../README.ECI_initiatives.md#-testing).

**Setup test environment:**

```bash
cd ECI_initiatives/tests
deactivate  # Exit production venv if active
uv venv
uv pip install -r requirements.test.txt
source .venv/bin/activate  # or .venv\Scripts\activate on Windows
cd ..  # Back to ECI_initiatives/
```

**Run tests:**

```bash
python run_tests.py --merger
```
## üìä Output

The module produces a final merged CSV in the same timestamped data directory:
`data/{TIMESTAMP}/eci_merger_responses_and_followup_{DATE}.csv`

This file contains **36 columns** covering the full lifecycle of the initiative, from submission to final legislative implementation.

## üñ•Ô∏è Usage

For detailed setup and environment configuration, see the [main project documentation](../../README.ECI_initiatives.md#-quick-start-end-to-end).

**Quick Start:**

```bash
# From project root
cd ECI_initiatives

python -m data_pipeline.csv_merger.responses
```
## üõ†Ô∏è Prerequisites

- **Python 3.8+**

### Python Dependencies

See the [main project documentation](../../README.ECI_initiatives.md#-quick-start-end-to-end) for detailed installation instructions.

```bash
pip install -r ECI_initiatives/data_pipeline/requirements.prod.txt
```

## üîó Dependencies

**Data Dependencies:**

Must be run **after** both extractor modules. Requires the existence of both:
1. `eci_responses_{TIMESTAMP}.csv` from `extractor.responses`
2. `eci_responses_followup_website_{TIMESTAMP}.csv` from `extractor.responses_followup_website`

Both files must be in the latest timestamped `data/` subdirectory.