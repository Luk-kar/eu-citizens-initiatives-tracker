# ECI Data Merger

This module is the **final consolidation step** in the ECI pipeline. It takes the two parallel datasets generated by the extraction process‚Äîthe official Commission response data and the granular follow-up website data‚Äîand intelligently merges them into a single, comprehensive accountability record.

## üöÄ Purpose

The merger reconciles the "official promise" with the "evolving reality":

- **Base Data** (`eci_responses_*.csv`): Captures the official Commission Answer text, original deadlines, and formal commitments at the moment of response.
- **Follow-up Data** (`eci_responses_followup_website_*.csv`): Captures updated timelines, implementation dates, and specific actions (workshops, studies) from dedicated project sites.

**Key Goals:**
- **Accountability**: Distinguish between what was *originally promised* vs. what is *currently planned* (e.g., merging deadlines with clear labeling).
- **Completeness**: Fill gaps where one source has data the other misses (e.g., specific legislation IDs found only in follow-up text).
- **Integrity**: Enforce strict validation rules (e.g., `registration_number` must match) and prevent illogical status updates (e.g., warning if dates move backward).

## üìÇ Project Structure

- **`responses/merger.py`**: The core engine that orchestrates the file loading, validation, and row-by-row merging.
- **`responses/strategies.py`**: Defines field-specific merge logic (e.g., `merge_dates_by_latest`, `merge_json_lists`, `merge_by_concatenation`).
- **`responses/exceptions.py`**: Custom errors for data integrity failures (e.g., `ImmutableFieldConflictError`).
- **`responses/cli.py`**: Command-line interface logic.

## ‚öôÔ∏è Merge Strategy

The merger uses a column-by-column strategy to handle data conflicts. It doesn't just "overwrite"‚Äîit makes semantic decisions based on the field type:

| Field Type | Strategy | Example |
| :--- | :--- | :--- |
| **Immutable IDs** | `Keep Base` | `registration_number` (never changes) |
| **Outcomes** | `Prioritize Followup` | `final_outcome_status` (e.g. updates from "Studying" -> "Adopted") |
| **Text/Reasons** | `Concatenate` | `commission_rejection_reason` (keeps original + adds new updates) |
| **Dates** | `Max / Latest` | `followup_latest_date` (always takes the most future date) |
| **Lists (JSON)** | `Merge & Deduplicate` | `laws_actions`, `court_cases_referenced` (combines unique items) |
| **Booleans** | `Logical OR` | `commission_promised_new_law` (once promised, always true) |

*Full strategy details are documented in `strategies.py`.*

## üìä Output

The module produces a final merged CSV in the same timestamped data directory:
`data/{TIMESTAMP}/eci_merger_responses_and_followup_{DATE}.csv`

This file contains **36 columns** covering the full lifecycle of the initiative, from submission to final legislative implementation.

## üñ•Ô∏è Usage

Run the module after both extraction steps (`extractor.responses` and `extractor.responses_followup_website`) have completed.

```bash
# Using uv (recommended)
uv run -m csv_merger.responses

# Standard python
python -m csv_merger.responses
```

## üîó Dependencies

- Requires **Python 3.8+**
- **Critical Dependency**: Must be run **last**. It requires the existence of both:
  1. `eci_responses_{TIMESTAMP}.csv`
  2. `eci_responses_followup_website_{TIMESTAMP}.csv`
  in the latest `data/` subdirectory.
```